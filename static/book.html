<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Book Your Flight</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="https://i.pinimg.com/1200x/59/0f/e7/590fe784586d6b274d278d91df2a5d8e.jpg" type="image/x-icon">
    <style>
        body {
            font-family: 'Rubik', Arial, sans-serif;
            background-image: url(https://i.pinimg.com/1200x/58/01/01/5801010ade9ef4cbc9bf36989b0f47fd.jpg);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            padding-top: 8rem;
            min-height: 100vh;
            padding: 40px 20px;
    }

        .container {
            max-width: 600px;
            background: rgba(255, 255, 255, 0.836);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        h2 {
            color: #013170;
            margin-bottom: 25px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Complete Your Booking</h2>
        <div id="booking-info">
            <p class="text-muted">Flight ID: <span id="flight-id-display"></span></p>
            <p class="text-muted">Route: <span id="route-display"></span></p>
            <p class="text-muted">Class: <span id="class-display"></span> | Passengers: <span id="passengers-display"></span></p>
        </div>
        <hr>

        <form id="booking-form">
            <div class="mb-3">
                <label for="name" class="form-label">Lead Passenger Name</label>
                <input type="text" class="form-control" id="name" required placeholder="Enter Name">
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" required placeholder="name@example.com">
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="book-btn">Proceed to Payment</button>
            </div>
            <p class="mt-3 text-danger" id="error-message"></p>
            <p class="mt-3 text-success" id="success-message"></p>
        </form>
    </div>

    <script>
        const apiBase = window.location.origin.startsWith('http') ? window.location.origin : 'http://127.0.0.1:5000';

        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const flightId = getQueryParam('flight_id');
            const source = getQueryParam('source');
            const destination = getQueryParam('destination');
            const flightClass = getQueryParam('class');
            const passengers = getQueryParam('passengers');
            const date = getQueryParam('date');
            
            document.getElementById('flight-id-display').innerText = flightId;
            document.getElementById('route-display').innerText = `${source} to ${destination} (${date})`;
            document.getElementById('class-display').innerText = flightClass;
            document.getElementById('passengers-display').innerText = passengers;

            if (!flightId) {
                document.getElementById('error-message').innerText = "Missing flight information.";
                document.getElementById('book-btn').disabled = true;
                return;
            }

            document.getElementById('booking-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const bookBtn = document.getElementById('book-btn');
                const errorMsg = document.getElementById('error-message');

                bookBtn.disabled = true;
                bookBtn.innerText = 'Creating Booking...';
                errorMsg.innerText = '';

                try {
                  const data = {
                        flight_id: flightId,
                        passengers: parseInt(passengers),
                        class: flightClass,
                        date: date, // Pass the date
                        source_code: source, // FIX: Pass the source code
                        dest_code: destination, // FIX: Pass the destination code
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value
                    };
                    const res = await fetch(`${apiBase}/create-booking`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    const result = await res.json();

                    if (!res.ok) {
                        errorMsg.innerText = result.error || 'Booking failed.';
                        bookBtn.disabled = false;
                        bookBtn.innerText = 'Proceed to Payment';
                        return;
                    }

                    // Success: Redirect to Payment page
                    document.getElementById('success-message').innerText = 'Booking created! Redirecting to payment...';
                    setTimeout(() => {
                        window.location.href = `/static/payment.html?booking_id=${result.booking_id}`;
                    }, 500);

                } catch (err) {
                    console.error(err);
                    errorMsg.innerText = 'Network error while creating booking. Is the app.py server running?';
                    bookBtn.disabled = false;
                    bookBtn.innerText = 'Proceed to Payment';
                }
            });
        });
    </script>
</body>
</html>