<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Boarding Pass - CONFIRMED</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="https://i.pinimg.com/1200x/59/0f/e7/590fe784586d6b274d278d91df2a5d8e.jpg" type="image/x-icon">
    <style>
        body {
            font-family: 'Rubik', Arial, sans-serif;
            background: url(https://i.pinimg.com/1200x/58/01/01/5801010ade9ef4cbc9bf36989b0f47fd.jpg);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            padding-top: 8rem;
            min-height: 100vh;
            padding: 40px 20px;
        }
        .ticket-card {
            max-width: 600px;
            background: #ffffffc9;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border: 2px solid #013170;
            position: absolute;  
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: hidden;
        }
        .ticket-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background-color: #013170;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color:  #013170;
            font-weight: 900;
        }
        .segment {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        .label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
            display: block;
        }
        .value {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }
        .route-path {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }
        .route-path .code {
            font-size: 30px;
            font-weight: 900;
            color: #003478;
        }
        .route-path .arrow {
            font-size: 24px;
            color: #00439a;
        }
        .barcode {
            display: block;
            margin: 20px auto 0 auto;  
            width: 70%;               
            max-width: 200px;         
            height: 80px;             
            background-color: #fff;   
            border: 1px solid #013170;
            border-radius: 6px;
            padding: 5px;             
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            text-align: center;       
        }
    </style>
</head>
<body>
    <div class="ticket-card" id="ticket-card" style="display:none;">
        <div class="header">
            <h1 id="airline-name">RiraXOne</h1>
            <p class="text-success lead" id="status-text">BOOKING CONFIRMED!!</p>
        </div>

        <div id="loading">Loading confirmed ticket details...</div>

        <div id="content" style="display:none;">
            <div class="segment">
                <div class="row">
                    <div class="col-6">
                        <span class="label">PNR</span>
                        <span class="value" id="pnr-display"></span>
                    </div>
                    <div class="col-6 text-end">
                        <span class="label">FLIGHT/CLASS</span>
                        <span class="value" id="flight-class-display"></span>
                    </div>
                </div>
            </div>

            <div class="segment">
                <div class="route-path">
                    <div>
                        <div class="code" id="from-code-display"></div>
                        <span class="label" id="from-city-display"></span>
                    </div>
                    <div class="arrow">✈️</div>
                    <div>
                        <div class="code" id="to-code-display"></div>
                        <span class="label" id="to-city-display"></span>
                    </div>
                </div>
            </div>

            <div class="segment">
                <div class="row">
                    <div class="col-4">
                        <span class="label">DATE</span>
                        <span class="value" id="date-display"></span>
                    </div>
                    <div class="col-4">
                        <span class="label">DEP. TIME</span>
                        <span class="value" id="time-display"></span>
                    </div>
                    <div class="col-4">
                        <span class="label">PASSENGERS</span>
                        <span class="value" id="passengers-display"></span>
                    </div>
                </div>
            </div>

            <div class="barcode">
                <img src="https://barcode.tec-it.com/barcode.ashx?data=BOOKING-&code=Code128&multiplelines=true&unit=mil&modulewidth=10&height=150&bgcolor=FFFFFF&color=000000" alt="Barcode" id="barcode-img">
                <span class="label mt-2 d-block">Present this code at check-in</span>
            </div>
        </div>
    </div>

    <script>
        const apiBase = window.location.origin.startsWith('http') ? window.location.origin : 'http://127.0.0.1:5000';

        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        async function loadBoardingPass() {
            const bookingId = getQueryParam('booking_id');
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');
            const ticketCard = document.getElementById('ticket-card');

            ticketCard.style.display = 'block';

            if (!bookingId) {
                loading.innerText = 'Missing booking ID in URL.';
                return;
            }

            try {
                // API Call to the Flask backend
                const res = await fetch(`${apiBase}/booking/${bookingId}`);
                const data = await res.json();

                loading.style.display = 'none';

                if (!res.ok) {
                    content.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to retrieve ticket. Booking not found or payment failed.'}</div>`;
                    content.style.display = 'block';
                    return;
                }
                
                // Populate fields
                document.getElementById('airline-name').innerText = data.airline_name || 'RiraXOne';
                document.getElementById('pnr-display').innerText = data.pnr || 'N/A';
                document.getElementById('flight-class-display').innerText = `${data.flight_id || 'M999'}/${data.class || 'ECO'}`;
                
                document.getElementById('from-code-display').innerText = data.from_code || 'N/A';
                document.getElementById('from-city-display').innerText = data.from_city || 'Origin';
                document.getElementById('to-code-display').innerText = data.to_code || 'N/A';
                document.getElementById('to-city-display').innerText = data.to_city || 'Destination';

                document.getElementById('date-display').innerText = data.travel_date || 'N/A';
                document.getElementById('time-display').innerText = data.departure_time || 'N/A';
                document.getElementById('passengers-display').innerText = data.passengers || 1;

                // Update barcode image using the PNR
                const barcodeUrl = `https://barcode.tec-it.com/barcode.ashx?data=${data.pnr || 'TICKET'}&code=Code128&multiplelines=true&unit=mil&modulewidth=10&height=150&bgcolor=FFFFFF&color=000000`;
                document.getElementById('barcode-img').src = barcodeUrl;

                content.style.display = 'block';
                
            } catch (err) {
                console.error(err);
                loading.innerText = 'Network error while fetching ticket details. Is the app.py server running?';
            }
        }

        document.addEventListener('DOMContentLoaded', loadBoardingPass);
    </script>
</body>
</html>